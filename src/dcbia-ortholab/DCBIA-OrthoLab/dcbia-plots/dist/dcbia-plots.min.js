var dcbiaPlots=angular.module("dcbia-plots",[]);angular.module("dcbia-plots").directive("boxPlotChart",["$compile","$rootScope",function(a,b){return{restrict:"E",template:'<div id="{{elementId}}" style="width:100%"></div>',scope:{height:"=height",margin:"=margin",boxdata:"=data",boxPlotTitle:"=",legendY:"=",legendX:"="},link:function(a,b,c){a.elementId=_.uniqueId("chartArea"),a.refresh=function(){var c=_.find(b.children(),function(b){return b.id===a.elementId}),d=1/0,e=-1/0;a.width=c.clientWidth;var f,g=[],h=[],i=[],j=0;a.boxdata.data.length>0&&(f=_.keys(a.boxdata.data[0]));var k=_.pluck(a.boxdata.data,"_id"),l=_.object(k,a.boxdata.data);_.each(f,function(b){if("_id"!==b&&"_rev"!==b){var c=_.map(_.pluck(a.boxdata.data,b),function(a,b){return{key:k[b],value:a}});c=_.filter(c,function(a){return _.isNumber(a.value)&&!_.isNaN(a.value)}),c.length>0&&(g[j]=c,a.boxdata.normalize?(g=_.map(g,function(a){var b=_.max(_.pluck(a,"value"));return _.map(a,function(a){return a.value=a.value/b,a})}),e=1,d=0):_.each(g[j],function(a){a.value>e&&(e=a.value),a.value<d&&(d=a.value)}),j++)}});var m=d3.box().whiskers(function(a){return function(b,c){for(var d=b.quartiles[0],e=b.quartiles[2],f=(e-d)*a,c=-1,g=b.length;b[++c]<d-f;);for(;b[--g]>e+f;);return[c,g]}}(1.5)).width(a.width).height(a.height);m.domain([d,e]),void 0!==a.svg&&d3.select("#"+a.elementId).select("svg").remove();var n=a.width-100,o=a.height+a.margin.top+a.margin.bottom;a.svg=d3.select(c).insert("svg").attr("id","svgImage").attr("width",n).attr("height",o).attr("class","box").append("g");var p=d3.scale.ordinal().domain(g.map(function(a,b){return b})).rangeRoundBands([0,a.width],.7,.3),q=d3.svg.axis().scale(p).orient("bottom").tickFormat(function(a,b){return i&&i[b]&&i[b][0]?i[b][0]:h[a]}),r=d3.scale.linear().domain([d,e]).range([a.height+a.margin.top,a.margin.bottom]),s=d3.svg.axis().scale(r).orient("left");a.svg.selectAll(".box").data(_.map(g,function(a){return _.pluck(a,"value")})).enter().append("g").attr("transform",function(b,c){return"translate("+(100+p(c))+","+a.margin.top+")"}).call(m.width(p.rangeBand())),a.svg.append("text").attr("x",a.width/2).attr("y",a.margin.top/2).attr("text-anchor","middle").style("font-size","18px").text(a.boxPlotTitle),a.svg.append("g").attr("class","axis").attr("transform","translate(100,"+o+")").call(q).append("text").attr("transform","rotate(-90)").attr("x",o/2).attr("y",-100).style("text-anchor","middle").style("font-size","14px").text(a.legendY),a.svg.append("g").attr("class","axis").attr("transform","translate(60, 0)").call(s).append("text").style("text-anchor","middle").attr("x",n/2).attr("y",o+40).attr("dy",".71em").style("font-size","14px").text(a.legendX);for(var t=[],u=0;u<g.length;u++)for(var v=0;v<g[u].length;v++){var w={};w.index=u,w.data=g[u][v].value,w.key=g[u][v].key,t.push(w)}a.svg.selectAll("circle").data(t).enter().append("circle").attr("class","circle").attr("style","cursor: pointer;").attr("cx",function(a){return p(a.index)+p.rangeBand()/2+100}).attr("cy",function(a){return r(a.data)}).attr("r",4).attr("id",function(a){return a.uniqueId=_.uniqueId("svgCircle_"),a.uniqueId}).on("click",function(b,c){_.isFunction(a.boxdata.circleAction)&&a.boxdata.circleAction(b.key)}).append("svg:title").text(function(a){return l[a.key].patientId+": "+a.data}).transition().duration(800)},a.$watch("boxdata",function(){void 0!==a.boxdata&&a.refresh()})}}}]),angular.module("dcbia-plots").directive("circlePlot",["$routeParams","$location",function(a,b){function c(a,b,c){a.plotParameters={},a.plotParameters.threshold=.01,a.plotParameters.diameter=600,a.plotParameters.tension=.85,a.plotParameters.upperValue=.44,a.plotParameters.link1="",a.plotParameters.link2="",a.positionNodes={},a.positionNodes.Left={},a.positionNodes.Right={},a.positionNodes.All={},a.positionNodes.Left.scalePointLeft=1.9,a.positionNodes.Right.scalePointRight=1.9,a.positionNodes.All.scalePointAll=2,a.positionNodes.Left.offsetXLeft=95,a.positionNodes.Right.offsetXRight=130,a.positionNodes.All.offsetXAll=85,a.positionNodes.Left.offsetYLeft=150,a.positionNodes.Right.offsetYRight=150,a.positionNodes.All.offsetYAll=110,a.scaleImgBrainTemplate={},a.scaleImgBrainTemplate.Left=80,a.scaleImgBrainTemplate.All=80,a.scaleImgBrainTemplate.Right=80,a.descriptionPlotDone=!1,a.plotID=_.uniqueId("divDiagram"),a.brainTemplateAllClass="AllPlotTemplate"+a.plotID,a.brainTemplateLeftClass="leftPlotTemplate"+a.plotID,a.brainTemplateRightClass="rightPlotTemplate"+a.plotID,a.brainTemplateImgAll="divBrainImgALL"+a.plotID,a.brainTemplateLinkAll="divBrainLinkALL"+a.plotID,a.brainTemplateImgLeft="divBrainImgLeft"+a.plotID,a.brainTemplateLinkLeft="divBrainLinkLeft"+a.plotID,a.brainTemplateImgRight="divBrainImgRight"+a.plotID,a.brainTemplateLinkRight="divBrainLinkRight"+a.plotID,a.choice={},a.choice.selection="Average",a.plotBrainTemplate=!1,a.plotBrainConnectivity=function(){a.plotView=!0;var b=a.plotData.fdt_matrix;console.log("MATRIX",b);var c=a.plotData.jsonTableDescripton;console.log("DESCRIPTION TABLE",c);var d=[],e=[];if(angular.isString(b)){for(var f=b.split("\n"),g=0;g<f.length;g++){for(var h=[],i=f[g].split("  "),j=0;j<i.length;j++)""!=i[j]&&h.push(i[j]);h.length>0&&d.push(h)}console.log(d);for(var g in d)d.length!=d[g].length&&console.log("Error dimension matrix");var k=[];for(var l in d){var m=0;for(var n in d[l])m+=parseFloat(d[l][n]);k.push(m)}for(var l in d){var o=[];for(var n in d[l])o.push(parseFloat(d[l][n])/k[l]);e.push(o)}}else e=b;for(var p=[],q=[],r=[],s=0,l=0;l<e.length;l++)q.push({});for(var t in c){var u=c[t].MatrixRow;if("-1"!=u){q[u-1]=c[t].VisuHierarchy+c[t].name;var v=c[t].VisuOrder;v>s&&(s=v),p.push(c[t])}}for(var l=0;l<s;l++)r.push("");for(var t in p){var w=p[t].VisuOrder;if("-1"!=w){var x=p[t].VisuHierarchy+p[t].name;if(void 0!=p[t].coord)var y=p[t].coord[0],z=p[t].coord[1],A=p[t].coord[2],B={name:x,x:y,y:z,z:A};else var B={name:x};r[w-1]=B}}var C=[];return e.forEach(function(a,b){var c=q.indexOf(r[b].name);if(-1!=c){var d=e[c],f=[];d.forEach(function(a,b){var c=q.indexOf(r[b].name);-1!=c&&f.push(d[c])}),C.push(f)}}),console.log("Matrix ordered"),console.log(C.length),{matrix:C,listOrdered:r}},a.resetCoord=function(){a.positionNodes.Left.scalePointLeft=1.9,a.positionNodes.Right.scalePointRight=1.9,a.positionNodes.All.scalePointAll=2,a.positionNodes.Left.offsetXLeft=95,a.positionNodes.Right.offsetXRight=130,a.positionNodes.All.offsetXAll=85,a.positionNodes.Left.offsetYLeft=150,a.positionNodes.Right.offsetYRight=150,a.positionNodes.All.offsetYAll=110,a.scaleImgBrainTemplate.Left=80,a.scaleImgBrainTemplate.All=80,a.scaleImgBrainTemplate.Right=80},a.AverageMatrix=function(a){var b=[];return a.forEach(function(c,d){var e=[];c.forEach(function(b,c){if(d==c)e.push(0);else if(c>d){var f;f=(a[d][c]+a[c][d])/2,e.push(f)}else e.push(-1)}),b.push(e)}),b},a.MaximumMatrix=function(a){var b=[];return a.forEach(function(c,d){var e=[];c.forEach(function(b,c){if(d==c)e.push(0);else if(c>d){var f;f=a[d][c]>a[c][d]?a[d][c]:a[c][d],e.push(f)}else e.push(-1)}),b.push(e)}),b},a.MinimumMatrix=function(a){var b=[];return a.forEach(function(c,d){var e=[];c.forEach(function(b,c){if(d==c)e.push(0);else if(c>d){var f;f=a[d][c]<a[c][d]?a[d][c]:a[c][d],e.push(f)}else e.push(-1)}),b.push(e)}),b},a.CreateDescription=function(b,c){if(console.log(a.plotData),a.plotData){console.log("valueCheck"+c);var d=b.matrix,e=[];e="Average"==c?a.AverageMatrix(d):"Maximum"==c?a.MaximumMatrix(d):a.MinimumMatrix(d);for(var f=b.listOrdered,g=[],h=f.length,i=0;i<h;i++){for(var j={name:f[i].name},k=[],l=[],m=0;m<h;m++)m!=i&&e[i][m]>"0"&&(k.push(parseFloat(e[i][m])),l.push(f[m]));j.size=k,j.imports=l,g.push(j)}return a.descriptionPlotDone=!0,g}},a.NewPlot=function(b,c,d){a.plotData&&(a.removeOldPlot(),a.plotVisible=!0,a.Plot())},a.removeOldPlot=function(){console.log("REMOVE");var b=document.getElementById("divPlot_"+a.plotID);null!=b&&b.parentNode.removeChild(b);var c=document.getElementById("tooltip_"+a.plotID);null!=c&&c.parentNode.removeChild(c);var d=document.getElementById("nodeTooltip_"+a.plotID);null!=d&&d.parentNode.removeChild(d);var e=document.getElementById(a.brainTemplateImgAll);null!=e&&e.parentNode.removeChild(e);var f=document.getElementById(a.brainTemplateLinkAll);null!=f&&f.parentNode.removeChild(f);var g=document.getElementById(a.brainTemplateImgRight);null!=g&&g.parentNode.removeChild(g);var h=document.getElementById(a.brainTemplateLinkRight);null!=h&&h.parentNode.removeChild(h);var i=document.getElementById(a.brainTemplateImgLeft);null!=i&&i.parentNode.removeChild(i);var j=document.getElementById(a.brainTemplateLinkLeft);null!=j&&j.parentNode.removeChild(j)},a.Plot=function(){var b=a.plotBrainConnectivity();a.removeOldPlot();var c=a.choice.selection;console.log(c+" method");var d=a.CreateDescription(b,c);if(1==a.descriptionPlotDone){var e=a.plotParameters.threshold,f=a.plotParameters.diameter,g=a.plotParameters.tension,h=a.plotParameters.upperValue;0!=h&&h<=e&&alert("The maximum upper value should be superior to the threshold value"),a.plotVisible=!0;var i=f/2,j=i-120,k=d3.layout.cluster().size([360,j]).sort(null).value(function(a){return a.size}),l=d3.layout.bundle(),m=d3.svg.line.radial().interpolate("bundle").tension(g).radius(function(a){return a.y}).angle(function(a){return a.x/180*Math.PI}),n=d3.select("#"+a.plotID).append("div").attr("class","tooltip").attr("id","tooltip_"+a.plotID).style("opacity",0),o={top:30,right:10,bottom:15,left:50},p=100-o.right-o.left,q=f,r=parseInt(f)+50,s=r+100,t=o.bottom,u=r+t,v=d3.select("#"+a.plotID).append("div").attr("width",s).attr("height",u).attr("class","divPlot").attr("id","divPlot_"+a.plotID),w=[],x=v.append("svg").attr("width",r).attr("height",u).attr("class","circlePlot").attr("id","circlePlot").append("g").attr("transform","translate("+i+","+i+")"),y=d3.scale.linear().range([q/2,0]).domain([e,h]),z=v.append("svg").attr("width",100).attr("height",u+10).attr("id","colorBar").attr("class","colorBar").append("g").attr("transform","translate("+o.left+","+u/4+")"),A=z.append("defs").append("linearGradient").attr("id","gradient"+a.plotID).attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%").attr("spreadMethod","pad");A.append("stop").attr("offset","0%").attr("stop-color",d3.hsl(240,1,.5)).attr("stop-opacity",1),A.append("stop").attr("offset","25%").attr("stop-color",d3.hsl(180,1,.5)).attr("stop-opacity",1),A.append("stop").attr("offset","50%").attr("stop-color",d3.hsl(120,1,.5)).attr("stop-opacity",1),A.append("stop").attr("offset","75%").attr("stop-color",d3.hsl(60,1,.5)).attr("stop-opacity",1),A.append("stop").attr("offset","100%").attr("stop-color",d3.hsl(0,1,.5)).attr("stop-opacity",1);a.plotID;z.append("rect").attr("class","grid-background").attr("width",p/1.5).attr("height",q/2).style("fill","url(#gradient"+a.plotID+")"),z.append("g").attr("class","axis").call(d3.svg.axis().scale(y).orient("left").ticks(10));var B=k.nodes(a.packageHierarchy(d));w=l(a.packageImports(B,e));var C=a.sizeMap(B,e),D=f/35,E=h-e,F=a.plotParameters.link1,G=a.plotParameters.link2;x.selectAll(".link").data(w).enter().append("path").attr("class","link").attr("stroke-width",function(a,b){return C[b]*D+E+"px"}).attr("stroke",function(b,c){return C[c]>=h?a.colorHSV("max",0,1):a.colorHSV(C[c],e,h)}).attr("d",m).on("mouseover",function(b,c){var d=b.length;F=b[0].key+a.plotID,G=b[d-1].key+a.plotID;var e=document.getElementById(F),f=document.getElementById(G);e.setAttribute("font-weight","bold"),f.setAttribute("font-weight","bold"),e.setAttribute("font-size","13px"),f.setAttribute("font-size","13px"),n.transition().duration(200).style("opacity",.9),n.html("Connectivity value : "+C[c].toFixed(5)).style("left",d3.event.pageX+"px").style("top",d3.event.pageY+28+"px")}).on("mouseout",function(b){var c=b.length;F=b[0].key+a.plotID,G=b[c-1].key+a.plotID;var d=document.getElementById(F),e=document.getElementById(G);d.setAttribute("font-weight","normal"),e.setAttribute("font-weight","normal"),d.setAttribute("font-size","11px"),e.setAttribute("font-size","11px"),n.transition().duration(500).style("opacity",0)});if(x.selectAll(".node").data(B.filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+a.y+")"}).append("text").attr("id",function(b){return b.key+a.plotID}).attr("dx",function(a){return a.x<180?8:-8}).attr("dy",".31em").attr("text-anchor",function(a){return a.x<180?"start":"end"}).attr("transform",function(a){return a.x<180?null:"rotate(180)"}).text(function(a){return a.key}).attr("font-weight",function(a){return a.key==G?"bold":"normal"}),d3.select(self.frameElement).style("height",f+"px"),void 0!=b.listOrdered[1].x){a.plotBrainTemplate=!0;var H=d3.select("."+a.brainTemplateAllClass).append("div").attr("class","divBrainImgALL").attr("id",a.brainTemplateImgAll),I=d3.select("."+a.brainTemplateAllClass).append("div").attr("class","divBrainLinkALL").attr("id",a.brainTemplateLinkAll),J=I.append("svg").attr("id","linksTemplate").attr("width",350).attr("height",420),K=a.scaleImgBrainTemplate.All+"%";console.log("scaleImgAll",K);var L=(H.append("img").attr("src","data/rsz_brainall.png").attr("class","bgimgAll").attr("id","bgimgAll").attr("width",K),J.append("defs").append("radialGradient").attr("id","blueCircle"+a.plotID).attr("gradientUnits","objectBoundingBox").attr("fx","30%").attr("fy","30%"));L.append("stop").attr("offset","0%").attr("stop-color","#FFFFFF"),L.append("stop").attr("offset","40%").attr("stop-color","#AA0000"),L.append("stop").attr("offset","100%").attr("stop-color","#660000");var M=d3.select("#"+a.plotID).append("div").attr("class","nodeTooltip").attr("id","nodeTooltip_"+a.plotID).style("opacity",0),N=b.listOrdered,O=d3.svg.line().interpolate("bundle").tension(g).x(function(a){return a.x}).y(function(a){return a.y});w.forEach(function(b,c){var d,f,g,i,j=b.length,k=b[0].key,l=b[j-1].key;N.forEach(function(b,c){var e=b.name.lastIndexOf("."),h=b.name.substring(e+1);h==k?(d=b.x+parseFloat(a.positionNodes.All.offsetXAll),d*=parseFloat(a.positionNodes.All.scalePointAll),g=-b.y,g+=parseFloat(a.positionNodes.All.offsetYAll),g*=parseFloat(a.positionNodes.All.scalePointAll)):h==l&&(f=b.x+parseFloat(a.positionNodes.All.offsetXAll),f*=parseFloat(a.positionNodes.All.scalePointAll),i=-b.y,i+=parseFloat(a.positionNodes.All.offsetYAll),i*=parseFloat(a.positionNodes.All.scalePointAll))});var m=[{x:d,y:g},{x:f,y:i}];J.append("path").attr("d",O(m)).attr("stroke",function(){return C[c]>=h?a.colorHSV("max",0,1):a.colorHSV(C[c],e,h)}).attr("stroke-width",function(){return 10*C[c]+"px"}).attr("fill","none")}),N.forEach(function(b,c){var d=b.x+parseFloat(a.positionNodes.All.offsetXAll),e=-b.y;e+=parseFloat(a.positionNodes.All.offsetYAll),J.append("circle").attr("cx",d*parseFloat(a.positionNodes.All.scalePointAll)).attr("cy",e*parseFloat(a.positionNodes.All.scalePointAll)).attr("r",4).style("fill","url(#blueCircle"+a.plotID+")").on("mouseover",function(a,c){M.transition().duration(200).style("opacity",.9);var d=b.name.lastIndexOf("."),e=b.name.substring(d+1);M.html("Seed : "+e).style("left",d3.event.pageX+"px").style("top",d3.event.pageY+"px")}).on("mouseout",function(a){M.transition().duration(500).style("opacity",0)})});var P=d3.select("."+a.brainTemplateLeftClass).append("div").attr("class","divBrainImgLeft").attr("id",a.brainTemplateImgLeft),Q=d3.select("."+a.brainTemplateLeftClass).append("div").attr("class","divBrainLinkLeft").attr("id",a.brainTemplateLinkLeft),R=Q.append("svg").attr("id","linksTemplate").attr("width",410).attr("height",400),S=a.scaleImgBrainTemplate.Left+"%";P.append("img").attr("src","data/rsz_brainleft.jpg").attr("class","bgimgLeft").attr("id","bgimgLeft").attr("width",S);w.forEach(function(b,c){var d=b.length,f=b[0].key,g=b[d-1].key,i=0,j=0,k=0,l=0,m=f.lastIndexOf("_"),n=f.substring(m+1),o=g.lastIndexOf("_"),p=g.substring(o+1);if("L"==n&&"L"==p){N.forEach(function(b,c){var d=b.name.lastIndexOf("."),e=b.name.substring(d+1);e==f?(i=parseFloat(-b.y)+parseFloat(a.positionNodes.Left.offsetXLeft),i*=parseFloat(a.positionNodes.Left.scalePointLeft),k=parseFloat(-b.z)+parseFloat(a.positionNodes.Left.offsetYLeft),k*=parseFloat(a.positionNodes.Left.scalePointLeft)):e==g&&(j=parseFloat(-b.y),j+=parseFloat(a.positionNodes.Left.offsetXLeft),j*=parseFloat(a.positionNodes.Left.scalePointLeft),l=parseFloat(-b.z),l+=parseFloat(a.positionNodes.Left.offsetYLeft),l*=parseFloat(a.positionNodes.Left.scalePointLeft))});var q=[{x:i,y:k},{x:j,y:l}];R.append("path").attr("d",O(q)).attr("stroke",function(){return C[c]>=h?a.colorHSV("max",0,1):a.colorHSV(C[c],e,h)}).attr("stroke-width",function(){return 10*C[c]+"px"}).attr("fill","none")}}),N.forEach(function(b,c){var d=(b.name,b.name.lastIndexOf("_"));if("L"==b.name.substring(d+1)){var e=parseFloat(-b.y),e=e+parseFloat(a.positionNodes.Left.offsetXLeft),f=parseFloat(-b.z);f+=parseFloat(a.positionNodes.Left.offsetYLeft);var g=e*parseFloat(a.positionNodes.Left.scalePointLeft),h=f*parseFloat(a.positionNodes.Left.scalePointLeft);R.append("circle").attr("cx",g).attr("cy",h).attr("r",4).style("fill","url(#blueCircle"+a.plotID+")").on("mouseover",function(a,c){M.transition().duration(200).style("opacity",.9);var d=b.name.lastIndexOf("."),e=b.name.substring(d+1);M.html("Seed : "+e).style("left",d3.event.pageX+"px").style("top",d3.event.pageY+"px")}).on("mouseout",function(a){M.transition().duration(500).style("opacity",0)})}});var T=d3.select("."+a.brainTemplateRightClass).append("div").attr("class","divBrainImgRight").attr("id",a.brainTemplateImgRight),U=d3.select("."+a.brainTemplateRightClass).append("div").attr("class","divBrainLinkRight").attr("id",a.brainTemplateLinkRight),V=U.append("svg").attr("id","linksTemplate").attr("width",410).attr("height",400),W=a.scaleImgBrainTemplate.Right+"%";T.append("img").attr("src","data/rsz_brainright.jpg").attr("class","bgimgRight").attr("id","bgimgRight").attr("width",W);w.forEach(function(b,c){var d,f,g,i,j=b.length,k=b[0].key,l=b[j-1].key,m=k.lastIndexOf("_"),n=k.substring(m+1),o=l.lastIndexOf("_"),p=l.substring(o+1);if("R"==n&&"R"==p){N.forEach(function(b,c){var e=b.name.lastIndexOf("."),h=b.name.substring(e+1);h==k?(d=b.y,d+=parseFloat(a.positionNodes.Right.offsetXRight),d*=parseFloat(a.positionNodes.Right.scalePointRight),g=-b.z,g+=parseFloat(a.positionNodes.Right.offsetYRight),g*=parseFloat(a.positionNodes.Right.scalePointRight)):h==l&&(f=b.y,f+=parseFloat(a.positionNodes.Right.offsetXRight),f*=parseFloat(a.positionNodes.Right.scalePointRight),i=-b.z,i+=parseFloat(a.positionNodes.Right.offsetYRight),i*=parseFloat(a.positionNodes.Right.scalePointRight))});var q=[{x:d,y:g},{x:f,y:i}];V.append("path").attr("d",O(q)).on().attr("stroke",function(){return C[c]>=h?a.colorHSV("max",0,1):a.colorHSV(C[c],e,h)}).attr("stroke-width",function(){return 10*C[c]+"px"}).attr("fill","none")}}),N.forEach(function(b,c){var d=(b.name,b.name.lastIndexOf("_"));if("R"==b.name.substring(d+1)){var e=b.y,e=e+parseFloat(a.positionNodes.Right.offsetXRight),f=-b.z;f+=parseFloat(a.positionNodes.Right.offsetYRight),V.append("circle").attr("cx",e*parseFloat(a.positionNodes.Right.scalePointRight)).attr("cy",f*parseFloat(a.positionNodes.Right.scalePointRight)).attr("r",4).style("fill","url(#blueCircle"+a.plotID+")").on("mouseover",function(a,c){M.transition().duration(200).style("opacity",.9);var d=b.name.lastIndexOf("."),e=b.name.substring(d+1);M.html("Seed : "+e).style("left",d3.event.pageX+"px").style("top",d3.event.pageY+"px")}).on("mouseout",function(a){M.transition().duration(500).style("opacity",0)})}})}else a.plotBrainTemplate=!1}},a.colorHSV=function(a,b,c){if("max"==a)var d=d3.hsl(0,1,.5);else var e=c-b,f=a-b,g=f/e,h=240*g,d=d3.hsl(240-h,1,.5);return d},a.sizeMap=function(a,b){var c=[];return a.forEach(function(a){a.size&&a.size.forEach(function(a){a>b&&c.push(a)})}),c},a.packageHierarchy=function(a){function b(a,d){var e,f=c[a];return f||(f=c[a]=d||{name:a,children:[]},a.length&&(f.parent=b(a.substring(0,e=a.lastIndexOf("."))),f.parent.children.push(f),f.key=a.substring(e+1))),f}var c={};return a.forEach(function(a){b(a.name,a)}),c[""]},a.packageImports=function(a,b){var c={},d=[];return a.forEach(function(a){c[a.name]=a}),a.forEach(function(a){a.imports&&a.imports.forEach(function(e,f){a.size[f]>b&&d.push({source:c[a.name],target:c[e.name]})})}),d},a.$watch("scaleImgBrainTemplate.All",function(){console.log("HelloWatch scale all brain template",a.scaleImgBrainTemplate.All),a.NewPlot()}),a.$watch("scaleImgBrainTemplate.Left",function(){console.log("HelloWatch scale left brain template",a.scaleImgBrainTemplate.Left),a.NewPlot()}),a.$watch("scaleImgBrainTemplate.Right",function(){console.log("HelloWatch scale right brain template",a.scaleImgBrainTemplate.Right),a.NewPlot()}),a.$watch("positionNodes.Left.scalePointLeft",function(){console.log("HelloWatch scaleLeft",a.positionNodes.Left.scalePointLeft),a.NewPlot()}),a.$watch("positionNodes.Left.offsetXLeft",function(){console.log("HelloWatch offsetXLeft",a.positionNodes.Left.offsetXLeft),a.NewPlot()}),a.$watch("positionNodes.Left.offsetYLeft",function(){console.log("HelloWatch offsetYLeft",a.positionNodes.Left.offsetYLeft),a.NewPlot()}),a.$watch("positionNodes.All.scalePointAll",function(){console.log("HelloWatch scaleAll",a.positionNodes.All.scalePointAll),a.NewPlot()}),a.$watch("positionNodes.All.offsetXAll",function(){console.log("HelloWatch offsetXAll",a.positionNodes.All.offsetXAll),a.NewPlot()}),a.$watch("positionNodes.All.offsetYAll",function(){console.log("HelloWatch offsetYAll",a.positionNodes.All.offsetYAll),a.NewPlot()}),a.$watch("positionNodes.Right.scalePointRight",function(){console.log("HelloWatch scaleRight",a.positionNodes.Right.scalePointRight),a.NewPlot()}),a.$watch("positionNodes.Right.offsetXRight",function(){console.log("HelloWatch offsetXRight",a.positionNodes.Right.offsetXRight),a.NewPlot()}),a.$watch("positionNodes.Right.offsetYRight",function(){console.log("HelloWatch offsetYRight",a.positionNodes.Right.offsetYRight),a.NewPlot()}),a.$watch("plotParameters.link1",function(){console.log("HelloWatch link1",a.plotParameters.link1),a.NewPlot()}),a.$watch("plotParameters.link2",function(){console.log("HelloWatch link2",a.plotParameters.link2),a.NewPlot()}),a.$watch("plotParameters.threshold",function(){console.log("HelloWatch thres",a.plotParameters.threshold),a.NewPlot()}),a.$watch("plotParameters.diameter",function(){console.log("HelloWatch diam",a.plotParameters.diameter),a.NewPlot()}),a.$watch("plotParameters.tension",function(){console.log("HelloWatch tension",a.plotParameters.tension),a.NewPlot()}),a.$watch("plotParameters.upperValue",function(){console.log("HelloWatch upper",a.plotParameters.upperValue),a.NewPlot()}),a.$watch("choice.selection",function(){console.log("HelloWatch choiceSelection",a.choice.selection),a.NewPlot()}),a.$watch("plotData",function(){a.plotData&&(a.plotParameters.plotData=a.plotData,a.Plot())})}return{restrict:"E",scope:{plotData:"="},link:c,templateUrl:"./src/circlePlot.template.html"}}]),angular.module("dcbia-plots").directive("d3Plots",["$routeParams","$location","$rootScope","clusterauth","dcbia",function(a,b,c,d,e){function f(a,b){function c(b,c,d){b&&(a.compareTwoVariables={},a.compareTwoVariables.data=b,a.compareTwoVariables.carac1=c,a.compareTwoVariables.carac2=d)}a.elementId=_.uniqueId("d3Plots"),b.attr("id",a.elementId),a.graph={axis:{}},a.boxplotdata={},a.height=600,a.margin={left:80,right:80,top:40,bottom:40},a.update=function(){},a.$watch("data",function(){a.data&&a.update()}),a.$watch("graph.axis.x",function(){var d=a.data;void 0!=a.svg&&0==a.graph.type&&void 0!=b.children()[2]&&b.children()[2].remove(),void 0!=a.graph.axis.x&&void 0!=a.graph.axis.y&&c(d,a.graph.axis.x,a.graph.axis.y)}),a.$watch("graph.axis.y",function(){var d=a.data;void 0!=a.svg&&0==a.graph.type&&void 0!=b.children()[2]&&b.children()[2].remove(),void 0!=a.graph.axis.x&&void 0!=a.graph.axis.y&&c(d,a.graph.axis.x,a.graph.axis.y)}),a.$watch("graph.type",function(){var d=a.data,e={};_.each(d,function(a){_.extend(e,a)}),delete e._id,delete e._rev,delete e.type,a.keys=_.map(_.keys(e),function(a,b){return{id:b,label:a}}),void 0!=a.svg&&(0==a.graph.type&&void 0!=b.children()[2]&&b.children()[2].remove(),1==a.graph.type&&void 0!=b.children()[1]&&b.children()[1].remove()),0==a.graph.type?void 0!=a.graph.axis.x&&void 0!=a.graph.axis.y&&c(d,a.graph.axis.x.label,a.graph.axis.y.label):a.displayAllCaracteristics(d)}),a.circleAction=function(b){_.find(a.boxplotdata.data,function(a){return a._id===b})},a.getMorphologicalDataByPatientId=function(b){e.getMorphologicalDataByPatientId(b).then(function(b){a.attachments={},a.attachments.data=_.flatten(_.map(b.data,function(a){return _.map(a._attachments,function(b,c){return{id:a._id,label:c}})}))})},a.displayAllCaracteristics=function(b){b&&(a.boxplotdata={},a.boxplotdata.data=b,a.boxplotdata.normalize=a.graph.normalize,a.boxplotdata.circleAction=a.circleAction)},a.$watch("graph.normalize",function(){a.displayAllCaracteristics(a.data)}),a.$watch("attachments.selected",function(){a.attachments&&a.attachments.selected&&e.getAttachement(a.attachments.selected.id,a.attachments.selected.label,"arraybuffer").then(function(b){a.attachments.surface=b.data})}),a.multiSeries={subjects:{},selectedVariables:{}},a.multiSeries.addSubjects=function(b){void 0===a.multiSeries.subjects&&(a.multiSeries.subjects={}),_.each(b,function(b){a.multiSeries.subjects[b._id]=!0})},a.multiSeries.addVariables=function(b){_.each(b,function(b){a.multiSeries.selectedVariables[b.label]=!0})},a.multiSeries.update=function(){var b=_.compact(_.map(a.multiSeries.selectedVariables,function(a,b){if(a)return b})),c=_.map(b,function(b){var c={};return _.each(a.multiSeries.subjects,function(d,e){if(d){var f=_.find(a.data,function(a){return e===a._id});c[f.patientId]=f[b]}}),c});a.multiSeries.data={},a.multiSeries.data.lines=_.compact(c),a.multiSeries.data.labels=b,a.multiSeries.data.action=a.getMorphologicalDataByPatientId}}return{restrict:"E",link:f,scope:{data:"="},templateUrl:"./src/d3Plots.template.html"}}]),angular.module("dcbia-plots").directive("preprocessingPlotChart",["$compile","$rootScope",function(a,b){function c(a,b,c){a.plotID=_.uniqueId("preprocessingPlot");a.svg=null,a.drawHeatMap=function(b){var c=window.innerWidth,d=(window.innerHeight,b.attributes.colors),e=b.attributes.scale;c=1100;var f={top:50,right:0,bottom:0,left:95},g=c-f.left-f.right,h=Math.floor(g/b.namesx.length),k=g+200-f.top-f.bottom,l=a.svg,m=a.div;a.svg||(m=d3.select("#"+a.plotID).append("div").attr("class","tooltip").style("opacity",0),l=d3.select("#"+a.plotID).append("svg").attr("width",g+f.left+f.right).attr("height",k+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")"),a.div=m,a.svg=l),l.selectAll("*").remove();var n=(l.selectAll(".num_componentsLabel").data(b.namesy).enter().append("text").text(function(a){return a}).attr("x",0).attr("y",function(a,b){return b*h}).style("text-anchor","end").attr("transform","translate(-6,"+h/1.5+")").attr("class",function(a,b){return b>=0&&b<=4?"num_componentsLabel mono axis axis-num_components":"num_componentsLabel mono axis"}),l.selectAll(".covariatesLabel").data(b.namesx).enter().append("text").text(function(a){return a}).attr("x",0).attr("y",function(a,b){return b*h}).style("text-anchor","middle").attr("transform","translate("+h/2+", -"+h/2+")rotate(-90)").attr("class",function(a,b){return b>=7&&b<=16?"covariatesLabel mono axis axis-covariates":"covariatesLabel mono axis"}),d3.scaleLinear().domain(e).range(d).interpolate(d3.interpolateRgb));for(i=0;i<b.namesy.length;i++)for(j=0;j<b.namesx.length;j++){var o=l.selectAll(".pvalues").data(b.heat_map,function(a){return a[i][j]});o.append("title");o.enter().append("rect").attr("x",j*h).attr("y",i*h).attr("rx",4).attr("ry",4).attr("class","covariates bordered").attr("width",h).attr("height",h).style("fill",n(b.heat_map[i][j])).on("mouseover",function(a){m.transition().duration(200).style("opacity",.6),m.html(Math.round(1e4*b.heat_map[this.y.animVal.value/h][this.x.animVal.value/h])/1e4).style("left",this.x.animVal.value+f.left+"px").style("top",this.y.animVal.value+f.top+h/2+14+"px")}),o.exit().remove(),m.exit().remove()}},a.$watch("data",function(b){null!=b&&null!=b.heat_map&&(b.attributes||(b.attributes={colors:["#ff0000","#ffff00","#008000","#0000ff"],scale:[0,.01,.05,.05001,1]}),a.drawHeatMap(b))},!0)}return{restrict:"E",scope:{preprocessingPlotTitle:"=",data:"="},link:c,templateUrl:"./src/preprocessingPlot.template.html"}}]),angular.module("dcbia-plots").run(["$templateCache",function(a){"use strict";a.put("./src/boxPlot.template.html",'<div ng-include src="\'views/partials/navbar.html\'"></div>\n<div ng-controller="boxPlotController" class="row">\n\t<h2>BoxPlot chart</h2>\n\n    <box-plot-chart height="options.height" width="options.width" data="data" margin="options.margin"></box-plot-chart>\n</div>'),
a.put("./src/circlePlot.template.html",'<div class="buttons" ng-if="plotVisible">\n\n<div class="checkgroup" >\n\t<p class="matProc"> Matrix processing : </p>\n\n  <ng-form name="myForm">\n    <label for="average" class="methodChoice"> \n     <input type="radio" ng-model="choice.selection" value="Average" id="average"> Average  </label>\n     <label for="maximum"  class="methodChoice"> \n      <input type="radio" ng-model="choice.selection" value="Maximum" id="maximum"> Maximum </label>\n      <label for="minimum"  class="methodChoice">  \n       <input type="radio" ng-model="choice.selection" value="Minimum" id="minimum"> Minimum </label>\n\n\n  <p ng-if="plotVisible"> <div class="text" ng-if="plotVisible"> Maximum upper value : </div>\n<input type="text" pattern="[0-9]+([,\\.][0-9]+)?" value="1"\n ng-model="plotParameters.upperValue" ng-change="NewPlot" class="upperValue" ng-if="plotVisible" /> \n\n <div class="text" id="textMargin" ng-if="plotVisible"> Threshold value :  </div>\n<input type="text" pattern="[0-9]+([,\\.][0-9]+)?" value="0"\n ng-model="plotParameters.threshold" ng-change="NewPlot" class="ValueThreshold" ng-if="plotVisible" /> </p>\n \n  </div>\n\n<div class="slides">\n<p ng-if="plotVisible"> Tension splines value : </p>\n<input type="range" class="tensionBar" id="tensionBar" min="0" max="1" step="0.05" value="0.85" ng-if="plotVisible" ng-model="plotParameters.tension" ng-change="NewPlot"/> \n</div>\n\n<div class="slides">\n<p ng-if="plotVisible"> Diameter of circle : </p>\n<input type="range" class="diameterBar" id="diameterBar" min="300" max="1000" value="960" step="10" ng-if="plotVisible" ng-model="plotParameters.diameter" ng-change="NewPlot"/> \n</div>\n\n</div>\n\n<div id="{{plotID}}"> \n\n</div>\n\n<div class="brainTemplatePlot" id="brainTemplatePlot" ng-show="plotBrainTemplate">\n\n<h6 class="visuCheckbox"> Visualisation brain template connectivity : <input type="checkbox" name="showBrainTemplate" value="showBrainTemplate" ng-model="showBrainTemplate" ng-init="showBrainTemplate=false" />  </h6>\n\n<div class="brainTemplate" ng-show="showBrainTemplate" ng-model="showBrainTemplate" ng-change="plotBrainTemplate">\n\n<div class="divBrainLeft" id="divBrainLeft">\n\t<div class="{{brainTemplateLeftClass}}" id="{{brainTemplateLeftClass}}"> \n\t</div>\n\t<div class=modifCoord ng-if="modifCoordPosition">\n<div class=modifCoordTitles> Scale and location of nodes : <br/> </div>\n \tScale : <input type="range" min="0.01" max="5" step=0.1 ng-model="positionNodes.Left.scalePointLeft" ng-change="NewPlot">\n\n\tX-offset : <input type="range" min="-100" max="700" step=0.1 ng-model="positionNodes.Left.offsetXLeft" ng-change="NewPlot">\n\n\n\tY-offset : <input type="range" min="-100" max="700" step=0.1 ng-model="positionNodes.Left.offsetYLeft" ng-change="NewPlot">\n\t<div class=modifCoordTitles> Resize brain template : <br/> </div>\n\t<input type="range" min="30" max="100" step=1 ng-model="scaleImgBrainTemplate.Left" ng-change="NewPlot">\n</div>\n\t</div>\n\n\n<div class="divBrainALL" id="divBrainALL" >\n\t<div class="{{brainTemplateAllClass}}" id="{{brainTemplateAllClass}}"> \n\t</div>\n\t<div class=modifCoord ng-if="modifCoordPosition">\n<div class=modifCoordTitles> Scale and location of nodes : <br/> </div>\n\tScale : <input type="range" min="0.01" max="5" step=0.1 ng-model="positionNodes.All.scalePointAll" ng-change="NewPlot">\n\n\tX-offset : <input type="range" min="-100" max="500" step=0.1 ng-model="positionNodes.All.offsetXAll" ng-change="NewPlot">\n\n\n\tY-offset : <input type="range" min="-100" max="700" step=0.1 ng-model="positionNodes.All.offsetYAll" ng-change="NewPlot">\n\t<div class=modifCoordTitles> Resize brain template : <br/> </div>\n\t<input type="range" min="30" max="100" step=1 ng-model="scaleImgBrainTemplate.All" ng-change="NewPlot">\n</div>\n</div>\n\n<div class="divBrainRight" id="divBrainRight" >\n\t<div class="{{brainTemplateRightClass}}" id="{{brainTemplateRightClass}}"> \n\t</div>\n\t<div class=modifCoord ng-if="modifCoordPosition">\n<div class=modifCoordTitles> Scale and location of nodes : <br/> </div>\n\tScale : <input type="range" min="0.01" max="5" step=0.1 ng-model="positionNodes.Right.scalePointRight" ng-change="NewPlot">\n\n\tX-offset : <input type="range" min="-100" max="500" step=0.1 ng-model="positionNodes.Right.offsetXRight" ng-change="NewPlot">\n\n\n\tY-offset : <input type="range" min="-100" max="500" step=0.1 ng-model="positionNodes.Right.offsetYRight" ng-change="NewPlot">\n\t<div class=modifCoordTitles> Resize brain template : <br/> </div>\n\t<input type="range" min="30" max="100" step=1 ng-model="scaleImgBrainTemplate.Right" ng-change="NewPlot">\n</div>\n\t</div>\n\t<h6 class="changePositonCheckbox">  Change nodes and links position or/and scale : \n<input type="checkbox" name="modifCoordPosition" value="modifCoordPosition" ng-model="modifCoordPosition" ng-init="modifCoordPosition=false" /></h6>\n<button type="button" ng-click=resetCoord() class="resetCoordPos" ng-show="modifCoordPosition"> Reset position nodes and links </button>\n</div>\n\n</div>\n\n\n'),a.put("./src/d3Plots.template.html",'\n<div class="panel panel-info">\n    <div class="btn-group">\n         <button type="button" class="btn btn-default" ng-click="graph.type = 0">\n            <span class="glyphicon glyphicon-stats"></span>\n            Compare\n         </button>\n\n         <button type="button" class="btn btn-default" ng-click="graph.type = 2">\n            <span class="glyphicon glyphicon-stats"></span>\n            Line series\n         </button>\n    </div>\n</div>\n\n<div class="panel panel-default" ng-if = "graph.type == 0">\n    <div class="input-group">\n        <select class="form-control" ng-options="item as item.label for item in keys" ng-model="graph.axis.x"></select>\n        <select class="form-control" ng-options="item as item.label for item in keys" ng-model="graph.axis.y"></select>\n    </div>\n\n    <compare-two-variables data="compareTwoVariables" margin="margin" height="height" >\n\n    </compare-two-variables>\n</div>\n\n<div class="panel panel-default" ng-if = "graph.type == 1">\n\n\n    <div class="input-group">\n        <span class="input-group-addon">\n            <input type="checkbox" aria-label="..." ng-model="graph.normalize">\n        </span>\n        <label class="form-control" > Normalize</label>\n    </div>\n\n    <box-plot-chart \n      data="boxplotdata"\n      height="height"\n      margin="margin"\n      legend-y="legendYBP"\n      legend-x="legendXBP"\n      box-plot-title="titleBP"\n      style="margin: 20px; margin-bottom:50px;"\n    ></box-plot-chart>\n\n    <select class="form-control" ng-options="item as item.label for item in attachments.data" ng-model="attachments.selected"></select>\n    <directive-threejs data="attachments.surface" height="height" ng-if="attachments.surface"></directive-threejs>\n    \n</div>\n<div class="panel panel-info" ng-if = "graph.type == 2">\n\n    \n    <div class="col-md-12">\n        <div class="col-md-6">\n            <div class="btn-group">\n                 <button type="button" class="btn btn-default" ng-click="multiSeries.addVariables(multiSeries.displayedKeys)">\n                    <span class="glyphicon glyphicon-plus"></span>\n                    Add\n                 </button>\n\n                 <button type="button" class="btn btn-default" ng-click="multiSeries.addVariables(keys)">\n                    <span class="glyphicon glyphicon-plus"></span>\n                    Add all\n                 </button>\n\n                 <button type="button" class="btn btn-default" ng-click="multiSeries.selectedVariables = {}">\n                    <span class="glyphicon glyphicon-remove"></span>\n                    Remove all\n                 </button>\n            </div>\n\n            <table st-table="multiSeries.displayedKeys" st-safe-src="keys" class="table table-striped">\n                <thead>\n                    <tr>\n                        <th colspan="2">\n                            <input st-search="label" placeholder="search by variable name" class="input-sm form-control" type="search"/>\n                        </th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr ng-repeat="row in multiSeries.displayedKeys">\n                        <td>\n                            <div class="input-group">\n                                <input type="checkbox" ng-model="multiSeries.selectedVariables[row.label]">\n                            </div>\n                        </td>\n                        <td>{{row.label}}</td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n\n        <div class="col-md-6">\n            \n            <div class="btn-group">\n                 <button type="button" class="btn btn-default" ng-click="multiSeries.addSubjects(multiSeries.displayedSubjects)">\n                    <span class="glyphicon glyphicon-plus"></span>\n                    Add\n                 </button>\n\n                 <button type="button" class="btn btn-default" ng-click="multiSeries.addSubjects(data)">\n                    <span class="glyphicon glyphicon-plus"></span>\n                    Add all\n                 </button>\n\n                 <button type="button" class="btn btn-default" ng-click="multiSeries.subjects = {}">\n                    <span class="glyphicon glyphicon-remove"></span>\n                    Remove all\n                 </button>\n            </div>\n\n            <table st-table="multiSeries.displayedSubjects" st-safe-src="data" class="table table-striped">\n                <thead>\n                    <tr>\n                        <th colspan="2">\n                            <input st-search="patientId" placeholder="search by patientId " class="input-sm form-control" type="search"/>\n                        </th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr ng-repeat="row in multiSeries.displayedSubjects">\n                        <td>\n                            <div class="input-group">\n                                <input type="checkbox" ng-model="multiSeries.subjects[row._id]">\n                            </div>\n                        </td>\n                        <td>{{row.patientId}}</td>\n                    </tr>\n                </tbody>\n            </table>\n\n            \n        </div>\n\n        \n    </div>\n\n    <div class="col-md-12">\n        <div class="btn-group">\n             <button type="button" class="btn btn-default" ng-click="multiSeries.update()">\n                <span class="glyphicon glyphicon-refresh"></span>\n                Update\n             </button>\n        </div>\n        \n        <multi-series-line-chart\n            data="multiSeries.data"\n            height="height"\n            margin="margin"\n        ></multi-series-line-chart>\n\n        <select class="form-control" ng-options="item as item.label for item in attachments.data" ng-model="attachments.selected"></select>\n        <directive-threejs data="attachments.surface" height="height" ng-if="attachments.surface"></directive-threejs>\n    </div>\n</div>\n'),a.put("./src/preprocessingPlot.template.html",'\n<div class=panel panel-default ng-scope" style="overflow:scroll">\n\t<div id="{{plotID}}" class="col-md-5">\n\t</div>\n\t\x3c!-- <div id="dataset-picker"></div> --\x3e\n</div>\n')}]);